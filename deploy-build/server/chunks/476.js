"use strict";exports.id=476,exports.ids=[476],exports.modules={30476:(e,r,i)=>{i.d(r,{A:()=>j});var o=i(60687),t=i(43210),l=i.n(t),n=i(88931),a=i(16184),s=i(87088),c=i(51067),p=i(49205),m=i(33245),d=i(66803),g=i(13555),u=i(21771),h=i(56117);i(81844);var x=i(12850);let f=(0,g.Ay)("input")({display:"none"}),v=(0,g.Ay)("img")({width:"100%",height:"auto",maxHeight:"180px",objectFit:"cover",borderRadius:"4px"}),b=(0,g.Ay)("img")({width:"240px",height:"320px",objectFit:"cover",borderRadius:"4px",border:"1px solid #ccc"}),U={position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"90%",maxWidth:700,bgcolor:"background.paper",borderRadius:"12px",boxShadow:24,p:4,display:"flex",flexDirection:"column",alignItems:"center",maxHeight:"95vh",overflowY:"auto"};async function w(e,r,i){let o=async(e,r,i)=>new Promise((o,t)=>{let l=new Image;l.onload=()=>{let n=document.createElement("canvas");n.width=r,n.height=i;let a=n.getContext("2d"),s=0,c=0,p=l.width,m=l.height,d=r/i;p/m>d?(p=m*d,s=(l.width-p)/2):(m=p/d,c=(l.height-m)/2),a.drawImage(l,s,c,p,m,0,0,r,i),n.toBlob(r=>{if(!r)return void t(Error("Failed to create blob from canvas"));o(new File([r],e.name,{type:"image/png"}))},"image/png",1)},l.onerror=()=>t(Error("Failed to load image for resizing")),l.src=URL.createObjectURL(e)});try{console.log(`Original file size: ${(e.size/1024/1024).toFixed(2)} MB, type: ${e.type}`);let t=await o(e,r,i),l=await (0,x.A)(t,{maxSizeMB:1.5,useWebWorker:!0,fileType:"image/webp",initialQuality:.85});console.log(`Compressed WebP file size: ${(l.size/1024/1024).toFixed(2)} MB`);let n=e.name.substring(0,e.name.lastIndexOf(".")||e.name.length)+".webp";return new File([l],n,{type:"image/webp"})}catch(e){throw console.error("Error converting to WebP:",e),e}}async function y(e,r,i){if(e instanceof HTMLCanvasElement)return new Promise((r,o)=>{e.toBlob(e=>{if(!e){console.error("Canvas is empty for direct blob conversion"),o(Error("Canvas is empty during blob conversion"));return}r(new File([e],i,{type:e.type||"image/png"}))},"image/png",1)});{let o=new Image;o.src=e,await new Promise((e,r)=>{o.onload=e,o.onerror=r});let t=document.createElement("canvas");t.width=r.width,t.height=r.height;let l=t.getContext("2d");if(!l)throw Error("No 2d context");return l.drawImage(o,r.x,r.y,r.width,r.height,0,0,r.width,r.height),new Promise((e,r)=>{t.toBlob(o=>{if(!o){console.error("Canvas is empty for cropping"),r(Error("Canvas is empty during crop"));return}e(new File([o],i,{type:o.type||"image/png"}))},"image/png",1)})}}let j=l().forwardRef(({onUploadComplete:e,bucketName:r="card_images",pathPrefix:i="",resetKey:g=0,targetHeight:x=1200,targetWidth:j=900},R)=>{let[L,A]=(0,t.useState)([]),[C,E]=(0,t.useState)(!1),[I,k]=(0,t.useState)(null),[F,z]=(0,t.useState)(null),[S,O]=(0,t.useState)(null),$=(0,t.useRef)(null),[P,W]=(0,t.useState)(1),[B,D]=(0,t.useState)(.1),[M,N]=(0,t.useState)(3);(0,t.useEffect)(()=>{g>0&&T()},[g]);let T=()=>{L.forEach(e=>{e.previewUrl&&URL.revokeObjectURL(e.previewUrl),e.originalUrl&&URL.revokeObjectURL(e.originalUrl)}),F?.previewUrl&&URL.revokeObjectURL(F.previewUrl),A([]),z(null),k(null),e&&e({mainImageFiles:[],thumbnailImageFile:null})};l().useImperativeHandle(R,()=>({reset:T})),(0,t.useEffect)(()=>()=>{console.log("ImageUpload unmounting, cleaning up ALL URLs..."),L.forEach(e=>{e.previewUrl&&(console.log(`Unmount: Revoking URL for main image's preview: ${e.previewUrl}`),URL.revokeObjectURL(e.previewUrl)),e.originalUrl&&(console.log(`Unmount: Revoking URL for original image: ${e.originalUrl}`),URL.revokeObjectURL(e.originalUrl))}),F&&F.previewUrl&&(console.log(`Unmount: Revoking URL for manual thumbnail: ${F.previewUrl}`),URL.revokeObjectURL(F.previewUrl))},[]);let H=()=>{e&&e({mainImageFiles:L.map(e=>e.file),thumbnailImageFile:F?F.file:null})},Q=async e=>{try{if(!e.target.files||0===e.target.files.length)return void console.log("No files selected");E(!0),k(null);let r=[...e.target.files];console.log(`Processing ${r.length} files`);let i=[];for(let e of r){console.log(`Processing file: ${e.name}`);try{let r=await w(e,j,x),o=`file-${Date.now()}-${Math.random().toString(36).substring(2,11)}`,t=URL.createObjectURL(e),l=URL.createObjectURL(r);i.push({id:o,file:r,previewUrl:l,originalFile:e,originalUrl:t}),console.log(`File processed successfully: ${r.name}`)}catch(r){console.error(`Error processing file ${e.name}:`,r),k(`Error processing ${e.name}: ${r.message}`)}}A(e=>[...e,...i])}catch(e){console.error("Error handling files:",e),k(`Error handling files: ${e.message}`)}finally{E(!1)}},X=e=>{k(null);let r=L[e];A(L.filter((r,i)=>i!==e)),F&&F.sourceImageId===r.id&&(F.previewUrl&&URL.revokeObjectURL(F.previewUrl),z(null)),URL.revokeObjectURL(r.previewUrl),r.originalUrl&&URL.revokeObjectURL(r.originalUrl),H()},Y=e=>{let r=L[e];console.log("handleEditImage: Setting up cropper for file",r.id),O({fileWithId:r,index:e,imageSrcForCropper:r.originalUrl||r.previewUrl}),W(1)},Z=()=>{O(null)},_=async()=>{if($.current){if(!S)return void k("No image to crop");try{E(!0);let e=$.current.getCanvas();if(!e)throw Error("Failed to generate cropped image");let r=`cropped-${Date.now()}.png`,i=await y(e,{},r),o=await w(i,j,x),t=L.map((e,r)=>{if(r===S.index){e.previewUrl&&URL.revokeObjectURL(e.previewUrl);let r=URL.createObjectURL(o);return{...e,file:o,previewUrl:r}}return e});A(t),H()}catch(e){console.error("Error applying crop:",e),k(`Failed to apply crop: ${e.message}`)}finally{E(!1),Z()}}};(0,t.useRef)(null),(0,t.useRef)(null),(0,t.useEffect)(()=>{H()},[F,L]);let q=async e=>{try{E(!0),k(null);let r=L[e];if(!r)throw Error("Source image not found");let i=r.file;F?.previewUrl&&URL.revokeObjectURL(F.previewUrl);let o=URL.createObjectURL(i);z({file:i,previewUrl:o,sourceImageId:r.id}),console.log("Thumbnail set successfully from existing image")}catch(e){console.error("Error creating thumbnail:",e),k(`Failed to create thumbnail: ${e.message}`)}finally{E(!1)}};return(0,o.jsxs)(c.A,{elevation:2,sx:{p:2},children:[(0,o.jsx)(s.A,{variant:"h6",gutterBottom:!0,children:"Image Uploader (Drag & Drop, Crop, WebP)"}),(0,o.jsxs)("label",{htmlFor:"image-upload-input",children:[(0,o.jsx)(f,{accept:"image/*",id:"image-upload-input",multiple:!0,type:"file",onChange:Q,disabled:C}),(0,o.jsx)(a.A,{variant:"contained",component:"span",disabled:C,startIcon:C?(0,o.jsx)(d.A,{size:20,color:"inherit"}):null,children:C?"Processing Files":"Select Images"})]}),I&&(0,o.jsx)(s.A,{color:"error",sx:{mt:2},children:I}),L.length>0&&(0,o.jsxs)(n.A,{sx:{mt:2},children:[(0,o.jsx)(s.A,{variant:"subtitle1",gutterBottom:!0,children:"Previews:"}),(0,o.jsx)(p.A,{container:!0,spacing:2,children:L.map((e,r)=>(0,o.jsx)(p.A,{item:!0,xs:6,sm:4,md:3,children:(0,o.jsxs)(n.A,{sx:{position:"relative"},children:[(0,o.jsx)(v,{src:e.previewUrl,alt:`Preview ${r+1}`}),(0,o.jsxs)(n.A,{sx:{position:"absolute",top:5,right:5,display:"flex",flexDirection:"column",gap:"5px"},children:[(0,o.jsx)(a.A,{size:"small",variant:"contained",onClick:e=>{e.stopPropagation(),Y(r)},disabled:C,sx:{minWidth:"auto",p:"2px 5px",fontSize:"0.7rem",mb:.5},title:"Crop image",children:"Edit"}),(0,o.jsx)(a.A,{size:"small",variant:"contained",color:"secondary",onClick:e=>{e.stopPropagation(),q(r)},disabled:C,sx:{minWidth:"auto",p:"2px 5px",fontSize:"0.7rem",mb:.5},children:"Make Thumb"}),(0,o.jsx)(a.A,{size:"small",color:"error",variant:"contained",onClick:e=>{e.stopPropagation(),console.log("Remove button clicked, index:",r),X(r)},disabled:C,sx:{minWidth:"auto",p:"2px 5px",fontSize:"0.7rem"},children:"X"})]})]})},e.id))})]}),S&&(0,o.jsx)(m.A,{open:!!S,onClose:Z,"aria-labelledby":"crop-image-modal-title",children:(0,o.jsxs)(n.A,{sx:U,children:[(0,o.jsx)(s.A,{id:"crop-image-modal-title",variant:"h6",component:"h2",sx:{mb:2},children:"Edit Image"}),S?.imageSrcForCropper&&(0,o.jsx)(n.A,{sx:{height:400,width:"100%",position:"relative",mb:2},children:(0,o.jsx)(h.IOb,{ref:$,src:S.imageSrcForCropper,stencilComponent:h.c2r,stencilProps:{aspectRatio:3/4},onReady:e=>{if(console.log("Cropper ready:",e),e){console.log("Using cropper instance from callback");try{e.zoomImage(P)}catch(e){console.error("Error applying zoom to cropper instance:",e)}}else if($.current){console.log("Using cropperRef.current");try{$.current.zoomImage(P)}catch(e){console.error("Error applying zoom to cropperRef.current:",e)}}else console.warn("No cropper instance available for setting zoom")},onChange:e=>{},className:"advanced-cropper"})}),!S?.imageSrcForCropper&&S&&(0,o.jsx)(s.A,{sx:{my:2,color:"error.main"},children:"Error: Original image source for cropper is missing."}),(0,o.jsxs)(n.A,{sx:{width:"80%",my:2},children:[(0,o.jsx)(s.A,{gutterBottom:!0,children:"Zoom"}),(0,o.jsx)(u.Ay,{value:P,min:B,max:M,step:.01,"aria-labelledby":"zoom-slider",valueLabelDisplay:"auto",onChange:(e,r)=>{W(r),$.current&&$.current.zoomImage(r)},disabled:C||!S})]}),C&&(0,o.jsx)(d.A,{sx:{my:2}}),(0,o.jsxs)(n.A,{sx:{mt:3,width:"100%",display:"flex",justifyContent:"flex-end"},children:[(0,o.jsx)(a.A,{onClick:Z,sx:{mr:1},disabled:C,children:"Cancel"}),(0,o.jsx)(a.A,{variant:"contained",onClick:_,disabled:C||!S,title:"Apply crop to the image",children:C?"Applying...":"Apply Crop"})]})]})}),F&&F.previewUrl&&(0,o.jsxs)(n.A,{sx:{mt:3,p:2,border:"1px dashed grey",display:"inline-block",position:"relative"},children:[(0,o.jsxs)(s.A,{variant:"subtitle2",gutterBottom:!0,children:["Current Thumbnail (from: ",L.find(e=>e.id===F.sourceImageId)?.file.name||"N/A",")"]}),(0,o.jsx)(b,{src:F.previewUrl,alt:"Manual Thumbnail Preview"}),(0,o.jsx)(a.A,{size:"small",color:"error",variant:"contained",onClick:()=>{F&&F.previewUrl&&URL.revokeObjectURL(F.previewUrl),z(null),H()},disabled:C,sx:{position:"absolute",top:10,right:10,minWidth:"auto",p:"2px 8px",fontSize:"0.7rem"},children:"Delete"})]})]})})}};