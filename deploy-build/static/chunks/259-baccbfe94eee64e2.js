"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[259],{15760:(e,r,i)=>{i.d(r,{A:()=>y});var o=i(95155),t=i(12115),l=i(54581),n=i(68534),a=i(700),s=i(18407),c=i(72110),p=i(16460),d=i(14426),m=i(75955),g=i(82330),u=i(66506);i(67994);var h=i(31802);let f=(0,m.Ay)("input")({display:"none"}),x=(0,m.Ay)("img")({width:"100%",height:"auto",maxHeight:"180px",objectFit:"cover",borderRadius:"4px"}),v=(0,m.Ay)("img")({width:"240px",height:"320px",objectFit:"cover",borderRadius:"4px",border:"1px solid #ccc"}),b={position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"90%",maxWidth:700,bgcolor:"background.paper",borderRadius:"12px",boxShadow:24,p:4,display:"flex",flexDirection:"column",alignItems:"center",maxHeight:"95vh",overflowY:"auto"};async function U(e,r,i){let o=async(e,r,i)=>new Promise((o,t)=>{let l=new Image;l.onload=()=>{let n=document.createElement("canvas");n.width=r,n.height=i;let a=n.getContext("2d"),s=0,c=0,p=l.width,d=l.height,m=r/i;p/d>m?(p=d*m,s=(l.width-p)/2):(d=p/m,c=(l.height-d)/2),a.drawImage(l,s,c,p,d,0,0,r,i),n.toBlob(r=>{if(!r)return void t(Error("Failed to create blob from canvas"));o(new File([r],e.name,{type:"image/png"}))},"image/png",1)},l.onerror=()=>t(Error("Failed to load image for resizing")),l.src=URL.createObjectURL(e)});try{console.log("Original file size: ".concat((e.size/1024/1024).toFixed(2)," MB, type: ").concat(e.type));let t=await o(e,r,i),l=await (0,h.A)(t,{maxSizeMB:1.5,useWebWorker:!0,fileType:"image/webp",initialQuality:.85});console.log("Compressed WebP file size: ".concat((l.size/1024/1024).toFixed(2)," MB"));let n=e.name.substring(0,e.name.lastIndexOf(".")||e.name.length)+".webp";return new File([l],n,{type:"image/webp"})}catch(e){throw console.error("Error converting to WebP:",e),e}}async function w(e,r,i){if(e instanceof HTMLCanvasElement)return new Promise((r,o)=>{e.toBlob(e=>{if(!e){console.error("Canvas is empty for direct blob conversion"),o(Error("Canvas is empty during blob conversion"));return}r(new File([e],i,{type:e.type||"image/png"}))},"image/png",1)});{let o=new Image;o.src=e,await new Promise((e,r)=>{o.onload=e,o.onerror=r});let t=document.createElement("canvas");t.width=r.width,t.height=r.height;let l=t.getContext("2d");if(!l)throw Error("No 2d context");return l.drawImage(o,r.x,r.y,r.width,r.height,0,0,r.width,r.height),new Promise((e,r)=>{t.toBlob(o=>{if(!o){console.error("Canvas is empty for cropping"),r(Error("Canvas is empty during crop"));return}e(new File([o],i,{type:o.type||"image/png"}))},"image/png",1)})}}let y=t.forwardRef((e,r)=>{var i;let{onUploadComplete:m,bucketName:h="card_images",pathPrefix:y="",resetKey:j=0,targetHeight:R=1200,targetWidth:L=900}=e,[I,A]=(0,t.useState)([]),[C,k]=(0,t.useState)(!1),[E,z]=(0,t.useState)(null),[F,O]=(0,t.useState)(null),[S,P]=(0,t.useState)(null),B=(0,t.useRef)(null),[N,W]=(0,t.useState)(1),[D,M]=(0,t.useState)(.1),[J,T]=(0,t.useState)(3);(0,t.useEffect)(()=>{j>0&&H()},[j]);let H=()=>{I.forEach(e=>{e.previewUrl&&URL.revokeObjectURL(e.previewUrl),e.originalUrl&&URL.revokeObjectURL(e.originalUrl)}),(null==F?void 0:F.previewUrl)&&URL.revokeObjectURL(F.previewUrl),A([]),O(null),z(null),m&&m({mainImageFiles:[],thumbnailImageFile:null})};t.useImperativeHandle(r,()=>({reset:H})),(0,t.useEffect)(()=>()=>{console.log("ImageUpload unmounting, cleaning up ALL URLs..."),I.forEach(e=>{e.previewUrl&&(console.log("Unmount: Revoking URL for main image's preview: ".concat(e.previewUrl)),URL.revokeObjectURL(e.previewUrl)),e.originalUrl&&(console.log("Unmount: Revoking URL for original image: ".concat(e.originalUrl)),URL.revokeObjectURL(e.originalUrl))}),F&&F.previewUrl&&(console.log("Unmount: Revoking URL for manual thumbnail: ".concat(F.previewUrl)),URL.revokeObjectURL(F.previewUrl))},[]);let _=()=>{m&&m({mainImageFiles:I.map(e=>e.file),thumbnailImageFile:F?F.file:null})},X=async e=>{try{if(!e.target.files||0===e.target.files.length)return void console.log("No files selected");k(!0),z(null);let r=[...e.target.files];console.log("Processing ".concat(r.length," files"));let i=[];for(let e of r){console.log("Processing file: ".concat(e.name));try{let r=await U(e,L,R),o="file-".concat(Date.now(),"-").concat(Math.random().toString(36).substring(2,11)),t=URL.createObjectURL(e),l=URL.createObjectURL(r);i.push({id:o,file:r,previewUrl:l,originalFile:e,originalUrl:t}),console.log("File processed successfully: ".concat(r.name))}catch(r){console.error("Error processing file ".concat(e.name,":"),r),z("Error processing ".concat(e.name,": ").concat(r.message))}}A(e=>[...e,...i])}catch(e){console.error("Error handling files:",e),z("Error handling files: ".concat(e.message))}finally{k(!1)}},Y=e=>{z(null);let r=I[e];A(I.filter((r,i)=>i!==e)),F&&F.sourceImageId===r.id&&(F.previewUrl&&URL.revokeObjectURL(F.previewUrl),O(null)),URL.revokeObjectURL(r.previewUrl),r.originalUrl&&URL.revokeObjectURL(r.originalUrl),_()},Z=e=>{let r=I[e];console.log("handleEditImage: Setting up cropper for file",r.id),P({fileWithId:r,index:e,imageSrcForCropper:r.originalUrl||r.previewUrl}),W(1)},G=()=>{P(null)},Q=async()=>{if(B.current){if(!S)return void z("No image to crop");try{k(!0);let e=B.current.getCanvas();if(!e)throw Error("Failed to generate cropped image");let r="cropped-".concat(Date.now(),".png"),i=await w(e,{},r),o=await U(i,L,R),t=I.map((e,r)=>{if(r===S.index){e.previewUrl&&URL.revokeObjectURL(e.previewUrl);let r=URL.createObjectURL(o);return{...e,file:o,previewUrl:r}}return e});A(t),_()}catch(e){console.error("Error applying crop:",e),z("Failed to apply crop: ".concat(e.message))}finally{k(!1),G()}}};(0,t.useRef)(null),(0,t.useRef)(null),(0,t.useEffect)(()=>{_()},[F,I]);let V=async e=>{try{k(!0),z(null);let r=I[e];if(!r)throw Error("Source image not found");let i=r.file;(null==F?void 0:F.previewUrl)&&URL.revokeObjectURL(F.previewUrl);let o=URL.createObjectURL(i);O({file:i,previewUrl:o,sourceImageId:r.id}),console.log("Thumbnail set successfully from existing image")}catch(e){console.error("Error creating thumbnail:",e),z("Failed to create thumbnail: ".concat(e.message))}finally{k(!1)}};return(0,o.jsxs)(s.A,{elevation:2,sx:{p:2},children:[(0,o.jsx)(a.A,{variant:"h6",gutterBottom:!0,children:"Image Uploader (Drag & Drop, Crop, WebP)"}),(0,o.jsxs)("label",{htmlFor:"image-upload-input",children:[(0,o.jsx)(f,{accept:"image/*",id:"image-upload-input",multiple:!0,type:"file",onChange:X,disabled:C}),(0,o.jsx)(n.A,{variant:"contained",component:"span",disabled:C,startIcon:C?(0,o.jsx)(d.A,{size:20,color:"inherit"}):null,children:C?"Processing Files":"Select Images"})]}),E&&(0,o.jsx)(a.A,{color:"error",sx:{mt:2},children:E}),I.length>0&&(0,o.jsxs)(l.A,{sx:{mt:2},children:[(0,o.jsx)(a.A,{variant:"subtitle1",gutterBottom:!0,children:"Previews:"}),(0,o.jsx)(c.A,{container:!0,spacing:2,children:I.map((e,r)=>(0,o.jsx)(c.A,{item:!0,xs:6,sm:4,md:3,children:(0,o.jsxs)(l.A,{sx:{position:"relative"},children:[(0,o.jsx)(x,{src:e.previewUrl,alt:"Preview ".concat(r+1)}),(0,o.jsxs)(l.A,{sx:{position:"absolute",top:5,right:5,display:"flex",flexDirection:"column",gap:"5px"},children:[(0,o.jsx)(n.A,{size:"small",variant:"contained",onClick:e=>{e.stopPropagation(),Z(r)},disabled:C,sx:{minWidth:"auto",p:"2px 5px",fontSize:"0.7rem",mb:.5},title:"Crop image",children:"Edit"}),(0,o.jsx)(n.A,{size:"small",variant:"contained",color:"secondary",onClick:e=>{e.stopPropagation(),V(r)},disabled:C,sx:{minWidth:"auto",p:"2px 5px",fontSize:"0.7rem",mb:.5},children:"Make Thumb"}),(0,o.jsx)(n.A,{size:"small",color:"error",variant:"contained",onClick:e=>{e.stopPropagation(),console.log("Remove button clicked, index:",r),Y(r)},disabled:C,sx:{minWidth:"auto",p:"2px 5px",fontSize:"0.7rem"},children:"X"})]})]})},e.id))})]}),S&&(0,o.jsx)(p.A,{open:!!S,onClose:G,"aria-labelledby":"crop-image-modal-title",children:(0,o.jsxs)(l.A,{sx:b,children:[(0,o.jsx)(a.A,{id:"crop-image-modal-title",variant:"h6",component:"h2",sx:{mb:2},children:"Edit Image"}),(null==S?void 0:S.imageSrcForCropper)&&(0,o.jsx)(l.A,{sx:{height:400,width:"100%",position:"relative",mb:2},children:(0,o.jsx)(u.IOb,{ref:B,src:S.imageSrcForCropper,stencilComponent:u.c2r,stencilProps:{aspectRatio:3/4},onReady:e=>{if(console.log("Cropper ready:",e),e){console.log("Using cropper instance from callback");try{e.zoomImage(N)}catch(e){console.error("Error applying zoom to cropper instance:",e)}}else if(B.current){console.log("Using cropperRef.current");try{B.current.zoomImage(N)}catch(e){console.error("Error applying zoom to cropperRef.current:",e)}}else console.warn("No cropper instance available for setting zoom")},onChange:e=>{},className:"advanced-cropper"})}),!(null==S?void 0:S.imageSrcForCropper)&&S&&(0,o.jsx)(a.A,{sx:{my:2,color:"error.main"},children:"Error: Original image source for cropper is missing."}),(0,o.jsxs)(l.A,{sx:{width:"80%",my:2},children:[(0,o.jsx)(a.A,{gutterBottom:!0,children:"Zoom"}),(0,o.jsx)(g.Ay,{value:N,min:D,max:J,step:.01,"aria-labelledby":"zoom-slider",valueLabelDisplay:"auto",onChange:(e,r)=>{W(r),B.current&&B.current.zoomImage(r)},disabled:C||!S})]}),C&&(0,o.jsx)(d.A,{sx:{my:2}}),(0,o.jsxs)(l.A,{sx:{mt:3,width:"100%",display:"flex",justifyContent:"flex-end"},children:[(0,o.jsx)(n.A,{onClick:G,sx:{mr:1},disabled:C,children:"Cancel"}),(0,o.jsx)(n.A,{variant:"contained",onClick:Q,disabled:C||!S,title:"Apply crop to the image",children:C?"Applying...":"Apply Crop"})]})]})}),F&&F.previewUrl&&(0,o.jsxs)(l.A,{sx:{mt:3,p:2,border:"1px dashed grey",display:"inline-block",position:"relative"},children:[(0,o.jsxs)(a.A,{variant:"subtitle2",gutterBottom:!0,children:["Current Thumbnail (from: ",(null==(i=I.find(e=>e.id===F.sourceImageId))?void 0:i.file.name)||"N/A",")"]}),(0,o.jsx)(v,{src:F.previewUrl,alt:"Manual Thumbnail Preview"}),(0,o.jsx)(n.A,{size:"small",color:"error",variant:"contained",onClick:()=>{F&&F.previewUrl&&URL.revokeObjectURL(F.previewUrl),O(null),_()},disabled:C,sx:{position:"absolute",top:10,right:10,minWidth:"auto",p:"2px 8px",fontSize:"0.7rem"},children:"Delete"})]})]})})},55954:(e,r,i)=>{i.d(r,{U:()=>t});var o=i(81935);function t(){return(0,o.createBrowserClient)("https://zyqebttgsbkjarthknns.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5cWVidHRnc2JramFydGhrbm5zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwNzkxNzcsImV4cCI6MjA2MzY1NTE3N30.o3K5QGPT-BL6y9iBnn4oaxkrD-Oed6mW3TALFk4vqJ8")}}}]);